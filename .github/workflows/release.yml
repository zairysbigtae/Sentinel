name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - x86_64-pc-windows-gnu

        include:
          - target: x86_64-unknown-linux-gnu
            cc: gcc
            cxx: g++
          - target: aarch64-unknown-linux-gnu
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
          - target: x86_64-pc-windows-gnu
            cc: x86_64-w64-mingw32-gcc
            cxx: x86_64-w64-mingw32-g++

    steps:
    - uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake wget unzip pkg-config
        sudo apt-get install -y mingw-w64

        # Only install ARM cross compilers for Linux targets
        TARGET=${{ matrix.target }}
        if [ "$TARGET" = "aarch64-unknown-linux-gnu" ]; then
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Build XGBoost (C library)
      run: |
        git clone --recursive https://github.com/dmlc/xgboost.git
        cd xgboost
        mkdir build && cd build
        cmake .. \
          -DUSE_CUDA=OFF \
          -DBUILD_SHARED_LIB=ON \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_INSTALL_PREFIX=$PWD/install \
          -DXGBOOST_USE_OPENMP=OFF
        cmake --build . --target install -j$(nproc)
      shell: bash

    - name: Build LIEF (C library)
      run: |
        git clone https://github.com/lief-project/LIEF.git
        cd LIEF
        mkdir build && cd build
        cmake .. \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_INSTALL_PREFIX=$PWD/install
        cmake --build . --target install -j$(nproc)
      shell: bash

    - name: Build LIEF wrapper
      run: |
        mkdir -p c_build
        ${{ matrix.cc }} -fPIC -shared \
          -o c_build/liblief_wrapper.so \
          c_code/lief_wrapper.c \
          -I LIEF/build/install/include \
          -L LIEF/build/install/lib \
          -lLIEF
      shell: bash

    - name: Clean Rust targets
      run: cargo clean

    - name: Build Rust project
      env:
        CC: ${{ matrix.cc }}
        CXX: ${{ matrix.cxx }}
        LIEF_WRAPPER_PATH: ${{ github.workspace }}/c_build
      run: cargo build --release --target ${{ matrix.target }}

    - name: Prepare artifacts
      run: mkdir -p artifacts

    - name: Copy binary
      run: cp target/${{ matrix.target }}/release/sentinel_src artifacts/

    - name: Generate SHA256 checksums
      run: |
        cd artifacts
        for f in *; do
          sha256sum "$f" > "$f.sha256"
        done

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

