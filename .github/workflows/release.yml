name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - x86_64-pc-windows-gnu

        include:
          - target: x86_64-unknown-linux-gnu
            cc: gcc
            cxx: g++
          - target: aarch64-unknown-linux-gnu
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
          - target: x86_64-pc-windows-gnu
            cc: x86_64-w64-mingw32-gcc
            cxx: x86_64-w64-mingw32-g++

    steps:
    - uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake wget unzip pkg-config
        sudo apt-get install -y mingw-w64

        # Only install ARM cross compilers for Linux targets
        TARGET=${{ matrix.target }}
        if [ "$TARGET" = "aarch64-unknown-linux-gnu" ]; then
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi

    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Build XGBoost (C library)
      run: |
        git clone --recursive https://github.com/dmlc/xgboost.git
        cd xgboost
        mkdir build && cd build

        # Set cross-compilation flags
        TARGET_ARCH=$(echo "${{ matrix.target }}" | cut -d- -f1)
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
            SYSTEM_NAME="Windows"
        else
            SYSTEM_NAME="Linux"
        fi

        cmake .. \
          -DUSE_CUDA=OFF \
          -DBUILD_SHARED_LIB=ON \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_INSTALL_PREFIX=$PWD/install \
          -DXGBOOST_USE_OPENMP=OFF \
          -DCMAKE_SYSTEM_NAME=$SYSTEM_NAME \
          -DCMAKE_SYSTEM_PROCESSOR=$TARGET_ARCH \
          -DCMAKE_C_COMPILER_WORKS=TRUE \
          -DCMAKE_CXX_COMPILER_WORKS=TRUE
        cmake --build . --target install -j$(nproc)
      shell: bash

    - name: Build LIEF (C library)
      run: |
        git clone https://github.com/lief-project/LIEF.git
        cd LIEF
        mkdir build && cd build

        # Set cross-compilation flags
        TARGET_ARCH=$(echo "${{ matrix.target }}" | cut -d- -f1)
        if [[ "${{ matrix.target }}" == *"windows"* ]]; then
            SYSTEM_NAME="Windows"
        else
            SYSTEM_NAME="Linux"
        fi

        cmake .. \
          -DLIEF_PYTHON_BINDING=OFF \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_INSTALL_PREFIX=$PWD/install \
          -DCMAKE_SYSTEM_NAME=$SYSTEM_NAME \
          -DCMAKE_SYSTEM_PROCESSOR=$TARGET_ARCH \
          -DCMAKE_C_COMPILER_WORKS=TRUE \
          -DCMAKE_CXX_COMPILER_WORKS=TRUE 
        cmake --build . --target install -j$(nproc)
      shell: bash

    - name: Build LIEF wrapper
      run: |
        mkdir -p c_build

        TARGET=${{ matrix.target }}
        if [[ "$TARGET" == *"windows"* ]]; then
            LIB_EXT="dll"
        else
            LIB_EXT="so"
        fi
        ${{ matrix.cc }} -fPIC -shared \
          -o c_code/exe/liblief_wrapper.$LIB_EXT \
          c_code/exe/lief_custom_wrapper.cpp \
          -I LIEF/build/install/include \
          -L LIEF/build/install/lib \
          -lLIEF
      shell: bash

    - name: Clean Rust targets
      run: cargo clean

    - name: Build Rust project
      env:
        CC: ${{ matrix.cc }}
        CXX: ${{ matrix.cxx }}
        LIEF_WRAPPER_PATH: ${{ github.workspace }}/c_build
        LIEF_LIB_PATH: ${{ github.workspace }}/LIEF/build/install/lib
        LIEF_INCLUDE_PATH: ${{ github.workspace }}/LIEF/build/install/include
      run: cargo build --release --target ${{ matrix.target }}

    - name: Prepare artifacts
      run: mkdir -p artifacts

    - name: Copy binary
      run: |
        BINARY_NAME="sentinel_src"
        [ "${{ matrix.target }}" = "x86_64-pc-windows-gnu" ] && BINARY_NAME="sentinel_src.exe"
        cp target/${{ matrix.target }}/release/$BINARY_NAME artifacts/

    - name: Generate SHA256 checksums
      run: |
        cd artifacts
        for f in *; do
          sha256sum "$f" > "$f.sha256"
        done

    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

